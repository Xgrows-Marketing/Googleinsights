<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Data - Google Ads Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 600;
            color: #4ade80;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 1.1rem;
        }

        .upload-card {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .upload-card:hover {
            transform: translateY(-2px);
            border-color: #4ade80;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            color: #e5e7eb;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 10px;
            padding: 15px;
            color: #ffffff;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ade80;
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
        }

        .form-input::placeholder {
            color: #6b7280;
        }

        .btn {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #000000;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(74, 222, 128, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #374151;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background: #4b5563;
            box-shadow: 0 10px 25px rgba(75, 85, 99, 0.3);
        }

        .preview-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }

        .preview-title {
            color: #4ade80;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: #111827;
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #374151;
            font-size: 0.9rem;
        }

        .preview-table th {
            background: #1f2937;
            color: #4ade80;
            font-weight: 600;
        }

        .preview-table td {
            color: #e5e7eb;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .status-loading {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .navigation {
            text-align: center;
            margin-top: 30px;
        }

        .nav-link {
            color: #4ade80;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: #22c55e;
            text-decoration: underline;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #374151;
            border-radius: 50%;
            border-top-color: #4ade80;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .instructions {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: #60a5fa;
            margin-bottom: 10px;
        }

        .instructions p {
            color: #cbd5e1;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .instructions code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #4ade80;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .upload-card {
                padding: 25px;
            }
            
            .preview-table {
                font-size: 0.8rem;
            }
            
            .preview-table th,
            .preview-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Data Upload</h1>
            <p class="subtitle">Update your Google Ads dashboard with fresh CSV data</p>
        </div>

        <div class="instructions">
            <h3>üìã How to get your CSV URL:</h3>
            <p><strong>From Google Sheets:</strong></p>
            <p>1. Open your Google Sheet</p>
            <p>2. Go to File ‚Üí Share ‚Üí Publish to web</p>
            <p>3. Select "Comma-separated values (.csv)"</p>
            <p>4. Click "Publish" and copy the URL</p>
            <p><strong>Example:</strong> <code>https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/export?format=csv</code></p>
        </div>

        <div class="upload-card">
            <form id="uploadForm">
                <div class="form-group">
                    <label for="csvUrl" class="form-label">CSV URL</label>
                    <input 
                        type="url" 
                        id="csvUrl" 
                        class="form-input" 
                        placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv"
                        required
                    >
                </div>

                <div class="form-group">
                    <button type="button" id="previewBtn" class="btn btn-secondary">
                        üìä Preview Data
                    </button>
                    <button type="submit" id="updateBtn" class="btn" disabled>
                        üöÄ Update Dashboard
                    </button>
                </div>
            </form>

            <div id="statusMessage" class="status-message"></div>
        </div>

        <div id="previewCard" class="preview-card">
            <h3 class="preview-title">Data Preview</h3>
            <div id="previewContent"></div>
        </div>

        <div class="navigation">
            <a href="index.html" class="nav-link">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <script>
        let parsedData = null;

        const csvUrlInput = document.getElementById('csvUrl');
        const previewBtn = document.getElementById('previewBtn');
        const updateBtn = document.getElementById('updateBtn');
        const statusMessage = document.getElementById('statusMessage');
        const previewCard = document.getElementById('previewCard');
        const previewContent = document.getElementById('previewContent');
        const uploadForm = document.getElementById('uploadForm');

        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
        }

        // Hide status message
        function hideStatus() {
            statusMessage.style.display = 'none';
        }

        // Preview data function
        async function previewData() {
            const url = csvUrlInput.value.trim();
            
            if (!url) {
                showStatus('Please enter a CSV URL', 'error');
                return;
            }

            previewBtn.innerHTML = '<span class="loading-spinner"></span>Loading...';
            previewBtn.disabled = true;
            showStatus('Fetching CSV data...', 'loading');

            try {
                // Convert Google Sheets edit URL to CSV export URL if needed
                let csvUrl = url;
                if (url.includes('/edit')) {
                    csvUrl = url.replace('/edit#gid=0', '/export?format=csv')
                                .replace('/edit?usp=sharing', '/export?format=csv')
                                .replace('/edit', '/export?format=csv');
                }

                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch CSV data');
                }
                
                const data = await response.json();
                const csvText = data.contents;

                // Parse CSV
                const parseResult = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                if (parseResult.errors.length > 0) {
                    throw new Error('CSV parsing errors: ' + parseResult.errors.map(e => e.message).join(', '));
                }

                parsedData = parseResult.data;
                
                // Show preview
                displayPreview(parsedData);
                showStatus(`Successfully loaded ${parsedData.length} rows of data`, 'success');
                updateBtn.disabled = false;

            } catch (error) {
                console.error('Error:', error);
                showStatus('Error loading CSV: ' + error.message, 'error');
                updateBtn.disabled = true;
                previewCard.style.display = 'none';
            } finally {
                previewBtn.innerHTML = 'üìä Preview Data';
                previewBtn.disabled = false;
            }
        }

        // Display data preview
        function displayPreview(data) {
            if (!data || data.length === 0) {
                previewContent.innerHTML = '<p>No data to preview</p>';
                return;
            }

            // Show only first few rows for preview
            const previewRows = data.slice(0, 5);
            const headers = Object.keys(previewRows[0]);

            let html = '<table class="preview-table"><thead><tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            previewRows.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';

            if (data.length > 5) {
                html += `<p style="margin-top: 10px; color: #9ca3af; text-align: center;">... and ${data.length - 5} more rows</p>`;
            }

            previewContent.innerHTML = html;
            previewCard.style.display = 'block';
        }

        // Update dashboard function
        function updateDashboard() {
            if (!parsedData) {
                showStatus('Please preview the data first', 'error');
                return;
            }

            updateBtn.innerHTML = '<span class="loading-spinner"></span>Updating...';
            updateBtn.disabled = true;

            try {
                // Extract the relevant data (assuming first row contains totals)
                const totalRow = parsedData[0];
                
                const dashboardData = {
                    dateRange: "Latest Data",
                    impressions: {
                        current: parseInt(totalRow['Impr.']) || 0,
                        previous: parseInt(totalRow['Impr. (Compare to)']) || 0,
                        change: parseFloat(totalRow['Impr. (Change %)']) || 0
                    },
                    interactions: {
                        current: parseInt(totalRow['Interactions']) || 0,
                        previous: parseInt(totalRow['Interactions (Compare to)']) || 0,
                        change: parseFloat(totalRow['Interactions (Change %)']) || 0
                    },
                    interactionRate: {
                        current: parseFloat(totalRow['Interaction rate']?.replace('%', '')) || 0,
                        previous: parseFloat(totalRow['Interaction rate (Compare to)']?.replace('%', '')) || 0,
                        change: parseFloat(totalRow['Interaction rate (Change %)']) || 0
                    },
                    avgCost: {
                        current: parseFloat(totalRow['Avg. cost']) || 0,
                        previous: parseFloat(totalRow['Avg. cost (Compare to)']) || 0,
                        change: parseFloat(totalRow['Avg. cost (Change %)']) || 0
                    },
                    totalCost: {
                        current: parseFloat(totalRow['Cost']) || 0,
                        previous: parseFloat(totalRow['Cost (Compare to)']) || 0,
                        change: parseFloat(totalRow['Cost (Change %)']) || 0
                    },
                    conversionRate: {
                        current: parseFloat(totalRow['Conv. rate']?.replace('%', '')) || 0,
                        previous: parseFloat(totalRow['Conv. rate (Compare to)']?.replace('%', '')) || 0,
                        change: parseFloat(totalRow['Conv. rate (Change %)']) || 0
                    },
                    conversions: {
                        current: parseFloat(totalRow['Conversions']) || 0,
                        previous: parseFloat(totalRow['Conversions (Compare to)']) || 0,
                        change: parseFloat(totalRow['Conversions (Change %)']) || 0
                    },
                    costPerConversion: {
                        current: parseFloat(totalRow['Cost / conv.']) || 0,
                        previous: parseFloat(totalRow['Cost / conv. (Compare to)']) || 0,
                        change: parseFloat(totalRow['Cost / conv. (Change %)']) || 0
                    },
                    lastUpdated: new Date().toISOString()
                };

                // Store in localStorage
                localStorage.setItem('googleAdsData', JSON.stringify(dashboardData));
                
                showStatus('Dashboard updated successfully! üéâ', 'success');
                
                // Redirect to dashboard after 2 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('Error updating dashboard:', error);
                showStatus('Error updating dashboard: ' + error.message, 'error');
            } finally {
                updateBtn.innerHTML = 'üöÄ Update Dashboard';
                updateBtn.disabled = false;
            }
        }

        // Event listeners
        previewBtn.addEventListener('click', previewData);
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            updateDashboard();
        });

        // Auto-hide status messages after 5 seconds
        setInterval(() => {
            if (statusMessage.style.display === 'block' && 
                statusMessage.classList.contains('status-error')) {
                hideStatus();
            }
        }, 5000);

        // Pre-fill URL if passed as parameter
        const urlParams = new URLSearchParams(window.location.search);
        const csvUrl = urlParams.get('url');
        if (csvUrl) {
            csvUrlInput.value = decodeURIComponent(csvUrl);
        }
    </script>
</body>
</html>
