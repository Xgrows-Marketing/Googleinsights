<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Data - Google Ads Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 600;
            color: #4ade80;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 1.1rem;
        }

        .upload-card {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .upload-card:hover {
            transform: translateY(-2px);
            border-color: #4ade80;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            color: #e5e7eb;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 10px;
            padding: 15px;
            color: #ffffff;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ade80;
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
        }

        .form-input::placeholder {
            color: #6b7280;
        }

        .btn {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #000000;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(74, 222, 128, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #374151;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background: #4b5563;
            box-shadow: 0 10px 25px rgba(75, 85, 99, 0.3);
        }

        .preview-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }

        .preview-title {
            color: #4ade80;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: #111827;
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #374151;
            font-size: 0.9rem;
        }

        .preview-table th {
            background: #1f2937;
            color: #4ade80;
            font-weight: 600;
        }

        .preview-table td {
            color: #e5e7eb;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .status-loading {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .navigation {
            text-align: center;
            margin-top: 30px;
        }

        .nav-link {
            color: #4ade80;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: #22c55e;
            text-decoration: underline;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #374151;
            border-radius: 50%;
            border-top-color: #4ade80;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .instructions {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: #60a5fa;
            margin-bottom: 10px;
        }

        .instructions p {
            color: #cbd5e1;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .instructions code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #4ade80;
        }

        .debug-info {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #fbbf24;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .upload-card {
                padding: 25px;
            }
            
            .preview-table {
                font-size: 0.8rem;
            }
            
            .preview-table th,
            .preview-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Data Upload</h1>
            <p class="subtitle">Update your Google Ads dashboard with fresh CSV data</p>
        </div>

        <div class="instructions">
            <h3>How to get your CSV URL:</h3>
            <p><strong>Just paste your Google Sheets URL - any format works!</strong></p>
            <p>Examples of URLs that work:</p>
            <p>‚úÖ <code>https://docs.google.com/spreadsheets/d/YOUR_ID/edit?usp=sharing</code></p>
            <p>‚úÖ <code>https://docs.google.com/spreadsheets/d/YOUR_ID/edit</code></p>
            <p>‚úÖ <code>https://docs.google.com/spreadsheets/d/e/2PACX.../export?format=csv</code></p>
            <p>‚úÖ <code>https://docs.google.com/spreadsheets/d/YOUR_ID/export?format=csv</code></p>
            <p><strong>The system automatically converts any Google Sheets URL to the correct CSV format!</strong></p>
            <p><em>Note: Make sure your sheet is set to "Anyone with the link can view"</em></p>
        </div>

        <div class="upload-card">
            <form id="uploadForm">
                <div class="form-group">
                    <label for="csvUrl" class="form-label">CSV URL</label>
                    <input 
                        type="url" 
                        id="csvUrl" 
                        class="form-input" 
                        placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv"
                        required
                    >
                </div>

                <div class="form-group">
                    <button type="button" id="previewBtn" class="btn btn-secondary">
                        üìä Preview Data
                    </button>
                    <button type="submit" id="updateBtn" class="btn" disabled>
                        üöÄ Update Dashboard
                    </button>
                </div>
            </form>

            <div id="statusMessage" class="status-message"></div>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </div>

        <div id="previewCard" class="preview-card">
            <h3 class="preview-title">Data Preview</h3>
            <div id="previewContent"></div>
        </div>

        <div class="navigation">
            <a href="index.html" class="nav-link">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <script>
        let parsedData = null;
        let rawCsvData = null;

        const csvUrlInput = document.getElementById('csvUrl');
        const previewBtn = document.getElementById('previewBtn');
        const updateBtn = document.getElementById('updateBtn');
        const statusMessage = document.getElementById('statusMessage');
        const previewCard = document.getElementById('previewCard');
        const previewContent = document.getElementById('previewContent');
        const uploadForm = document.getElementById('uploadForm');
        const debugInfo = document.getElementById('debugInfo');

        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
        }

        // Hide status message
        function hideStatus() {
            statusMessage.style.display = 'none';
        }

        // Show debug info
        function showDebug(message) {
            debugInfo.innerHTML = message;
            debugInfo.style.display = 'block';
        }

        // Preview data function
        async function previewData() {
            const url = csvUrlInput.value.trim();
            
            if (!url) {
                showStatus('Please enter a CSV URL', 'error');
                return;
            }

            previewBtn.innerHTML = '<span class="loading-spinner"></span>Loading...';
            previewBtn.disabled = true;
            showStatus('Fetching CSV data...', 'loading');

            try {
                // Convert Google Sheets edit URL to CSV export URL if needed
                let csvUrl = url;
                if (url.includes('/edit')) {
                    csvUrl = url.replace('/edit#gid=0', '/export?format=csv')
                                .replace('/edit?usp=sharing', '/export?format=csv')
                                .replace('/edit', '/export?format=csv');
                }

                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch CSV data');
                }
                
                const data = await response.json();
                const csvText = data.contents;
                rawCsvData = csvText;

                // Parse CSV without headers first to see raw structure
                const rawParseResult = Papa.parse(csvText, {
                    header: false,
                    skipEmptyLines: true
                });

                console.log('Raw CSV rows:', rawParseResult.data);
                
                // Find the row with "Total: Account" 
                let totalRowIndex = -1;
                let headerRowIndex = -1;
                
                // Debug: log all first column values
                console.log('All first column values:');
                rawParseResult.data.forEach((row, index) => {
                    console.log(`Row ${index}: "${String(row[0] || '').trim()}"`);
                });
                
                for (let i = 0; i < rawParseResult.data.length; i++) {
                    const row = rawParseResult.data[i];
                    const firstCell = String(row[0] || '').trim().toLowerCase();
                    
                    // Look for header row (contains "Search term" or similar)
                    if (firstCell.includes('search term') || 
                        row.some(cell => String(cell || '').toLowerCase().includes('impr.'))) {
                        headerRowIndex = i;
                    }
                    
                    // Look for total row - be more flexible
                    if ((firstCell.includes('total') && firstCell.includes('account')) ||
                        firstCell === 'total: account' ||
                        firstCell.includes('total:') ||
                        (firstCell.includes('total') && row.length > 5)) { // Row with "total" and multiple columns
                        totalRowIndex = i;
                        console.log(`Found potential total row at index ${i}: "${row[0]}"`);
                        break;
                    }
                }
                
                // If still not found, try to find any row that looks like summary data
                if (totalRowIndex === -1) {
                    console.log('No "Total" row found, looking for data rows...');
                    for (let i = 1; i < rawParseResult.data.length; i++) {
                        const row = rawParseResult.data[i];
                        // Look for rows with numeric data in multiple columns (likely summary data)
                        const numericColumns = row.filter(cell => {
                            const str = String(cell || '').replace(/[,$%]/g, '');
                            return !isNaN(parseFloat(str)) && parseFloat(str) > 0;
                        }).length;
                        
                        if (numericColumns >= 3) { // At least 3 numeric columns
                            totalRowIndex = i;
                            console.log(`Using row ${i} as data row (${numericColumns} numeric columns)`);
                            break;
                        }
                    }
                }

                console.log('Header row index:', headerRowIndex);
                console.log('Total row index:', totalRowIndex);

                if (totalRowIndex === -1) {
                    throw new Error('Could not find "Total: Account" row in the data');
                }

                // Use the header row if found, otherwise use row 0
                const actualHeaderRowIndex = headerRowIndex !== -1 ? headerRowIndex : 0;
                const headers = rawParseResult.data[actualHeaderRowIndex];
                const totalRowData = rawParseResult.data[totalRowIndex];

                // Create an object with headers as keys and total row data as values
                const totalRowObject = {};
                headers.forEach((header, index) => {
                    totalRowObject[header] = totalRowData[index] || '';
                });

                parsedData = [totalRowObject]; // Wrap in array for consistency
                
                console.log('Processed total row:', totalRowObject);
                
                // Show debug info
                showDebug(`
                    <strong>Debug Info:</strong><br>
                    ‚Ä¢ Found ${rawParseResult.data.length} total rows<br>
                    ‚Ä¢ Header row at index: ${actualHeaderRowIndex}<br>
                    ‚Ä¢ Total row at index: ${totalRowIndex}<br>
                    ‚Ä¢ Headers found: ${headers.length}<br>
                    ‚Ä¢ Sample header: "${headers[1] || 'N/A'}"
                `);
                
                // Show preview
                displayPreview([totalRowObject]);
                showStatus(`Successfully loaded Total Account data from row ${totalRowIndex + 1}`, 'success');
                updateBtn.disabled = false;

            } catch (error) {
                console.error('Error:', error);
                showStatus('Error loading CSV: ' + error.message, 'error');
                updateBtn.disabled = true;
                previewCard.style.display = 'none';
            } finally {
                previewBtn.innerHTML = 'üìä Preview Data';
                previewBtn.disabled = false;
            }
        }

        // Display data preview
        function displayPreview(data) {
            if (!data || data.length === 0) {
                previewContent.innerHTML = '<p>No data to preview</p>';
                return;
            }

            const row = data[0];
            const headers = Object.keys(row);

            let html = '<table class="preview-table"><thead><tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody><tr>';

            headers.forEach(header => {
                html += `<td>${row[header] || ''}</td>`;
            });
            html += '</tr></tbody></table>';

            html += `<p style="margin-top: 10px; color: #9ca3af; text-align: center;">Showing Total: Account row data</p>`;

            previewContent.innerHTML = html;
            previewCard.style.display = 'block';
        }

        // Update dashboard function
        function updateDashboard() {
            if (!parsedData || !parsedData[0]) {
                showStatus('Please preview the data first', 'error');
                return;
            }

            updateBtn.innerHTML = '<span class="loading-spinner"></span>Updating...';
            updateBtn.disabled = true;

            try {
                const totalRow = parsedData[0];
                console.log('Processing row:', totalRow);

                // Helper function to safely get numeric value
                function getNumericValue(value) {
                    if (value === null || value === undefined || value === '') return 0;
                    const str = String(value).replace(/[%,$]/g, '');
                    const num = parseFloat(str);
                    return isNaN(num) ? 0 : num;
                }

                // Helper function to find column value by partial name match
                function findColumnValue(row, searchTerms) {
                    for (const key of Object.keys(row)) {
                        for (const term of searchTerms) {
                            if (key.toLowerCase().includes(term.toLowerCase())) {
                                const value = getNumericValue(row[key]);
                                console.log(`Found ${term} in column "${key}": ${value}`);
                                return value;
                            }
                        }
                    }
                    console.log(`Could not find column for terms: ${searchTerms.join(', ')}`);
                    return 0;
                }

                // Extract data with flexible column matching
                const dashboardData = {
                    dateRange: "Latest Data Update",
                    impressions: {
                        current: findColumnValue(totalRow, ['impr.', 'impressions']),
                        previous: findColumnValue(totalRow, ['impr. (compare to)', 'impressions (compare to)']),
                        change: findColumnValue(totalRow, ['impr. (change', 'impressions (change'])
                    },
                    interactions: {
                        current: findColumnValue(totalRow, ['interactions']) || 
                               findColumnValue(totalRow, ['clicks']),
                        previous: findColumnValue(totalRow, ['interactions (compare to)', 'clicks (compare to)']),
                        change: findColumnValue(totalRow, ['interactions (change', 'clicks (change'])
                    },
                    interactionRate: {
                        current: findColumnValue(totalRow, ['interaction rate', 'ctr']),
                        previous: findColumnValue(totalRow, ['interaction rate (compare', 'ctr (compare']),
                        change: findColumnValue(totalRow, ['interaction rate (change', 'ctr (change'])
                    },
                    avgCost: {
                        current: findColumnValue(totalRow, ['avg. cost', 'avg cost']),
                        previous: findColumnValue(totalRow, ['avg. cost (compare', 'avg cost (compare']),
                        change: findColumnValue(totalRow, ['avg. cost (change', 'avg cost (change'])
                    },
                    totalCost: {
                        current: findColumnValue(totalRow, ['cost']) || 
                               findColumnValue(totalRow, ['spend']),
                        previous: findColumnValue(totalRow, ['cost (compare', 'spend (compare']),
                        change: findColumnValue(totalRow, ['cost (change', 'spend (change'])
                    },
                    conversionRate: {
                        current: findColumnValue(totalRow, ['conv. rate', 'conversion rate']),
                        previous: findColumnValue(totalRow, ['conv. rate (compare', 'conversion rate (compare']),
                        change: findColumnValue(totalRow, ['conv. rate (change', 'conversion rate (change'])
                    },
                    conversions: {
                        current: findColumnValue(totalRow, ['conversions']),
                        previous: findColumnValue(totalRow, ['conversions (compare']),
                        change: findColumnValue(totalRow, ['conversions (change'])
                    },
                    costPerConversion: {
                        current: findColumnValue(totalRow, ['cost / conv', 'cost per conv']),
                        previous: findColumnValue(totalRow, ['cost / conv (compare', 'cost per conv (compare']),
                        change: findColumnValue(totalRow, ['cost / conv (change', 'cost per conv (change'])
                    },
                    lastUpdated: new Date().toISOString()
                };

                console.log('Final dashboard data:', dashboardData);

                // Validate that we got some data
                const hasData = Object.values(dashboardData).some(metric => {
                    if (typeof metric === 'object' && metric.current !== undefined) {
                        return metric.current > 0;
                    }
                    return false;
                });

                if (!hasData) {
                    throw new Error('No valid data found. Please check that your CSV contains the expected Google Ads columns.');
                }

                // Store data
                if (typeof Storage !== "undefined") {
                    localStorage.setItem('googleAdsData', JSON.stringify(dashboardData));
                    showStatus('Dashboard updated successfully! üéâ', 'success');
                    
                    // Redirect to dashboard after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    throw new Error('Browser storage not supported');
                }

            } catch (error) {
                console.error('Error updating dashboard:', error);
                showStatus('Error updating dashboard: ' + error.message, 'error');
            } finally {
                updateBtn.innerHTML = 'üöÄ Update Dashboard';
                updateBtn.disabled = false;
            }
        }

        // Event listeners
        previewBtn.addEventListener('click', previewData);
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            updateDashboard();
        });

        // Auto-hide status messages after 5 seconds
        setInterval(() => {
            if (statusMessage.style.display === 'block' && 
                statusMessage.classList.contains('status-error')) {
                hideStatus();
            }
        }, 5000);

        // Pre-fill URL if passed as parameter
        const urlParams = new URLSearchParams(window.location.search);
        const csvUrl = urlParams.get('url');
        if (csvUrl) {
            csvUrlInput.value = decodeURIComponent(csvUrl);
        }
    </script>
</body>
</html>
